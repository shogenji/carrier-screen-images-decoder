<!DOCTYPE html>
<html lang="ja">

<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
    <meta charset="UTF-8">
    <title>Carrier-Screen-Images Decoder</title>
    <script src="./js/adapter.js"></script>

    <style>
    <!--
    html {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }

    body {
        width: 100%;
        height: 100%;
        margin: 0;
        padding: 0;
    }

    #decoded {
        object-fit: cover;
        position: absolute;
        left: 0;
        top: 0;
        z-index: 1;
        /*border: 1px solid #00f;*/
    }

    video #camera {
        object-fit: cover;
        position: absolute;
        left: 0;
        top: 0;
        z-index: -1;
        visibility: hidden;
        /* display: none; */
        /* width: 320;
        height: 320; */
        /*border: 2px solid #f00;*/
    }
    -->
    </style>

</head>
<body>
    <canvas id="decoded"></canvas>


    <video id="camera" autoplay muted playsinline></video>

    <script>

        var document = window.document;
        var navigator = window.navigator;
        var requestAnimationFrame = window.self.requestAnimationFrame;
        
        const video = document.getElementById("camera");
        setCanvasSize(video);
        
        const decoded   = document.getElementById("decoded");
        /* decoded.width   = window.innerWidth;
        decoded.height  = window.innerHeight; */
        var decoded_ctx = decoded.getContext("2d");
        setCanvasSize(decoded);

        var offscreen     = document.createElement("canvas");
        offscreen.width   = 1280;
        offscreen.height  = 1280;
        var offscreen_ctx = offscreen.getContext("2d");

        var interval = 3;
        var match = location.search.match(/interval=(.*?)(&|$)/);
        if(match) {
            interval = decodeURIComponent(match[1]);
        }
        console.log("interval: " + interval);

        var queue = null;
        var wait = 300;

        function loop() {
        
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                offscreen_ctx.drawImage(video, 0, 0, 1280, 1280, 0, 0, 1280, 1280);
                var src = new Image();
                var dst = new Image();
        
                src = offscreen_ctx.getImageData(0, 0, 1280, 1280);
                dst = offscreen_ctx.createImageData(1280, 1280);
        
                for (var y = 0; y < dst.height; y++) {
                    for (var x = 0; x < dst.width; x++) {
                        var yy = Math.floor(y / interval) * interval;
                            dst.data[(y * dst.width + x) * 4 + 0] = src.data[(yy * dst.width + x) * 4 + 0];
                            dst.data[(y * dst.width + x) * 4 + 1] = src.data[(yy * dst.width + x) * 4 + 1];
                            dst.data[(y * dst.width + x) * 4 + 2] = src.data[(yy * dst.width + x) * 4 + 2];
                            dst.data[(y * dst.width + x) * 4 + 3] = 255;
                    }
                }
        
                decoded_ctx.putImageData(dst, 0, 0);
            }
            requestAnimationFrame(loop);
        }
        
        function startStreaming(stream) {
            video.srcObject = stream;
            video.play();

            requestAnimationFrame(loop);
        }

        
        function start() {
            if (navigator.mediaDevices.getUserMedia) {
                //alert("navigator.mediaDevices.getUserMedia");
                let constraints = {video: {
                    frameRate: {min: 10, ideal: 30},
                    width: {min: 1280, ideal: 1280},
                    height: {min: 1280, ideal: 1280},
                    facingMode: {exact: 'environment'}
                }};

                // Get the video track of the camera stream

                navigator.mediaDevices.getUserMedia(constraints)
                .then(stream => {
                    video.srcObject = stream;
                    video.play();
                    setCanvasSize(decoded);
                    setCanvasSize(video);

                    requestAnimationFrame(loop);
                })
                .catch(err => {
                    alert("An error occured! " + err);
                });
            }
        }
        
        start();
    

        // Canvasサイズをコンテナの100%に
        function setCanvasSize(theCanvas) {
            let innerW = window.innerWidth;
            let innerH = window.innerHeight;
            console.log("window.innerWidth: " + innerW + "  window.innerHeight: " + innerH);

            theCanvas.setAttribute('width', innerW);
            theCanvas.setAttribute('height', innerH);
        }

        // リサイズ時にCanvasサイズを再設定
        window.addEventListener("resize", function() {
                    clearTimeout(queue);
                    queue = setTimeout(function() {
                        setCanvasSize(decoded);
                        setCanvasSize(video);
                    }, wait);
        }, false);


    </script>

</body>
</html>

